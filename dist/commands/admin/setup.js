"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const noRepetir = new Set(); // This set its a cooldown in the command :D
const database_1 = require("../../database/");
const lib_1 = require("../../lib");
const discord_js_1 = require("discord.js");
class SetupCommand extends lib_1.CommandBase {
    constructor() {
        // Name, Category, alias, cooldown
        super('setup', 'Admin', ["inicio"], 300);
    }
    async run(bot, message, args) {
        if (message.author.id !== message.guild.ownerId)
            return message.channel.send(bot.language.global.onlyOwner);
        if (noRepetir.has(message.author.id))
            return;
        noRepetir.add(message.author.id);
        const lang = bot.language.commands.setup;
        const wordsSi = ["si", "yes"];
        /**
         * Funcion para guardar los datos
         * @param {Boolean} pregunta1 Si solo el dueño borra canales
         * @param {String} pregunta2 Canal a enviar logs
         * @param {Boolean} pregunta3 Usuarios detecados ban auto
         * @param {Array} usuarios Usuarios los cuales pueden usar el bot
         * @param {Object} message Evento message
         */
        let i = 0;
        let usuariosAñadir = []; // Usuarios que se añaden
        let pregunta1; // Modo extremo
        let pregunta2; // Canal a enviar registros
        let pregunta3; // Detectar usuarios maliciosos y banearlos automaticamente
        const pregunta4 = [];
        const primerEmbedResponder = new discord_js_1.MessageEmbed()
            .setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }))
            .setFooter(lang.footer1)
            .setDescription(lang.descripcion1)
            .setColor('#16E724');
        message.channel.send({ embeds: [primerEmbedResponder] });
        const filter = (m) => m.author.id === message.author.id;
        const collector = message.channel.createMessageCollector({ filter, idle: 120000 });
        const mensajeDeError = new discord_js_1.MessageEmbed().setDescription(lang.mensajeError).setFooter(lang.footerError).setColor('#E70916').setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }));
        collector.on("collect", async (m) => {
            if (m.content.toLowerCase() === "exit")
                return collector.stop("exit");
            switch (i) {
                case 0:
                    if (["listo", "skip", "ready"].includes(m.content.toLowerCase())) {
                        i++;
                    }
                    else if (m.content) {
                        const usuario = m.mentions.users.first() || await bot.client.users.fetch(`${BigInt(m.content)}`).catch(err => { });
                        if (!usuario) {
                            message.channel.send({ embeds: [mensajeDeError] });
                            break;
                        }
                        if (usuariosAñadir.includes(usuario.id)) {
                            m.react('❌');
                            break;
                        }
                        usuariosAñadir.push(usuario.id);
                        m.react('✅');
                        break;
                    }
                    else {
                        await message.channel.send({ embeds: [mensajeDeError] });
                    }
                    const xtremEmbed = new discord_js_1.MessageEmbed().setDescription(lang.mensajeExtremo).setFooter(lang.footer1).setColor('#16E724').setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }));
                    await message.channel.send({ embeds: [xtremEmbed] });
                    break;
                case 1:
                    if (wordsSi.includes(m.content.toLowerCase())) {
                        pregunta1 = true;
                        i++;
                    }
                    else if (m.content.toLowerCase() == 'no') {
                        pregunta1 = false;
                        i++;
                    }
                    else {
                        message.channel.send(lang.respuestaSiNo);
                        break;
                    }
                    const attEmbed = new discord_js_1.MessageEmbed().setFooter(lang.footerAttack).setDescription(lang.canalEnviar).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true })).setColor(0xD30089);
                    await message.channel.send({ embeds: [attEmbed] });
                    // Registros de ataque
                    break;
                case 2:
                    const canal = m.mentions.channels.first() || await bot.client.channels.fetch(`${BigInt(m.content)}`).catch(() => null);
                    if (!canal) {
                        message.channel.send({ embeds: [mensajeDeError] });
                        break;
                    }
                    const noServerEmbed = new discord_js_1.MessageEmbed().setDescription(lang.noServer).setColor(0xD30089).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }));
                    if (canal.guild != m.guild) {
                        message.channel.send({ embeds: [noServerEmbed] });
                        break;
                    }
                    pregunta2 = canal.id;
                    i++;
                    const autoBanEmbed = new discord_js_1.MessageEmbed().setFooter(lang.autobanFooter).setDescription(lang.autoBan).setColor(0xD30089).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }));
                    await message.channel.send({ embeds: [autoBanEmbed] });
                    // AutoBan
                    break;
                case 3:
                    if (wordsSi.includes(m.content.toLowerCase())) {
                        i++;
                        pregunta3 = true;
                    }
                    else if (m.content.toLowerCase() == 'no') {
                        i++;
                        pregunta3 = false;
                    }
                    else {
                        const yesNoEmbed = new discord_js_1.MessageEmbed().setDescription(lang.respuestaSiNo).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true })).setColor("#EE4BB5");
                        message.channel.send({ embeds: [yesNoEmbed] });
                        break;
                    }
                    const protectedEmbed = new discord_js_1.MessageEmbed().setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true })).setDescription(lang.protected).setFooter(lang.protectedFooter);
                    await message.channel.send({ embeds: [protectedEmbed] });
                    break;
                case 4:
                    if (['no', 'skip', 'listo', 'ready'].includes(m.content.toLowerCase())) {
                        i++;
                        collector.stop("Finished");
                        break;
                    }
                    const canalProtegido = m.mentions.channels.first() || await bot.client.channels.fetch(`${BigInt(m.content)}`).catch(() => null);
                    if (canalProtegido) {
                        const noServerEmbed = new discord_js_1.MessageEmbed().setDescription(lang.noServer).setColor(0xD30089).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true }));
                        if (canalProtegido.guild != m.guild) {
                            message.channel.send({ embeds: [noServerEmbed] });
                            break;
                        }
                        if (pregunta4.length >= 3) {
                            m.react('❌');
                            const noTresEmbeds = new discord_js_1.MessageEmbed().setFooter(lang.canalesFooter).setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true })).setDescription(lang.noMas3canales);
                            message.channel.send({ embeds: [noTresEmbeds] });
                            break;
                        }
                        if (pregunta4.includes(canalProtegido.id)) {
                            m.react('❌');
                            break;
                        }
                        pregunta4.push(canalProtegido.id);
                        m.react('✅');
                    }
                    else {
                        const noChannelEmbed = new discord_js_1.MessageEmbed().setAuthor(message.member.displayName, message.author.avatarURL({ dynamic: true })).setDescription(lang.noCanal);
                        m.channel.send({ embeds: [noChannelEmbed] });
                        break;
                    }
            }
        });
        collector.on("end", async (collected, reason) => {
            noRepetir.delete(message.author.id);
            if (reason === "exit")
                return;
            const nuevoCanal = await bot.client.channels.fetch(`${BigInt(pregunta2)}`).catch(() => null);
            let datosPusheados = '';
            if (!pregunta4.length)
                datosPusheados = lang.nobody;
            else {
                for (let i = 0; i < pregunta4.length; i++) {
                    const element = await bot.client.channels.fetch(`${BigInt(pregunta4[i])}`).catch(() => null);
                    datosPusheados += `${element.toString()}\n`;
                }
            }
            switch (reason) {
                case 'Finished':
                    await verificar(pregunta1, pregunta2, pregunta3, usuariosAñadir, message, pregunta4);
                    const embedFinish = new discord_js_1.MessageEmbed()
                        .setTitle(lang.title2)
                        .setDescription(lang.descripcion2)
                        .addFields({
                        name: lang.field1,
                        value: usuariosAñadir.length == 0 ? lang.nobody : `${usuariosAñadir.length}`,
                        inline: true
                    }, {
                        name: lang.field2,
                        value: pregunta1 ? lang.si : lang.no,
                        inline: true
                    }, {
                        name: lang.field3,
                        value: nuevoCanal.toString(),
                        inline: true
                    }, {
                        name: lang.field4,
                        value: pregunta3 ? lang.si : lang.no,
                        inline: true
                    }, {
                        name: lang.field5,
                        value: datosPusheados,
                        inline: true
                    })
                        .setColor("RANDOM");
                    await message.channel.send({ embeds: [embedFinish] });
                    break;
                case 'idle':
                    message.channel.send(lang.noTime);
                    break;
                default:
                    if (reason == 'exit')
                        message.channel.send(lang.configCompletada);
                    else
                        message.channel.send(lang.errorColector + reason).catch(() => null);
                    break;
            }
        });
    }
}
exports.default = SetupCommand;
async function verificar(pregunta1, pregunta2, pregunta3, usuarios, message, pregunta4) {
    const esquema = new database_1.Registrador({
        guildId: message.guild.id,
        autoban: pregunta3,
        channel: pregunta2,
        users: usuarios,
        extrem: pregunta1 // Si solo el dueño puede borrar canales
    });
    const buscarEsquemas = await database_1.Registrador.findById(message.guild.id);
    buscarEsquemas ? await database_1.Registrador.findByIdAndUpdate(message.guild.id, { autoban: pregunta3, channel: pregunta2, users: usuarios, extrem: pregunta1 }) : await esquema.save();
    if (pregunta4.length >= 1) {
        const buscarCanales = await database_1.Channel.findById(message.guild.id);
        if (!buscarCanales) {
            await database_1.Channel.create({
                _id: message.guild.id,
                channel: pregunta4
            });
        }
        else {
            await buscarCanales.updateOne({ channel: pregunta4 });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbWFuZHMvYWRtaW4vc2V0dXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUMsNENBQTRDO0FBQ3pFLDhDQUF1RDtBQUN2RCxtQ0FBd0M7QUFFeEMsMkNBQThFO0FBQzlFLE1BQXFCLFlBQWEsU0FBUSxpQkFBVztJQUNqRDtRQUNJLGtDQUFrQztRQUNsQyxLQUFLLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFDRCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQVEsRUFBRSxPQUFnQixFQUFFLElBQW1CO1FBQ3JELElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPO1lBQUUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1RyxJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFBRSxPQUFPO1FBQzdDLFNBQVMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqQyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUM7UUFDekMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDOUI7Ozs7Ozs7V0FPRztRQUVILElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNWLElBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQyxDQUFDLHlCQUF5QjtRQUNsRCxJQUFJLFNBQWtCLENBQUMs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QUFPLEVBQUUsU0FBUztRQUNsQixPQUFPLEVBQUUsU0FBUztRQUNsQixLQUFLLEVBQUUsUUFBUTtRQUNmLE1BQU0sRUFBRSxTQUFTLENBQUMsd0NBQXdDO0tBQzdELENBQUMsQ0FBQztJQUNILE1BQU0sY0FBYyxHQUFHLE1BQU0sc0JBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNwRSxjQUFjLENBQUMsQ0FBQyxDQUFDLE1BQU0sc0JBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUM5SyxJQUFJLFNBQVMsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1FBQ3ZCLE1BQU0sYUFBYSxHQUFHLE1BQU0sa0JBQU8sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ2hCLE1BQU0sa0JBQU8sQ0FBQyxNQUFNLENBQUM7Z0JBQ2pCLEdBQUcsRUFBRSxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3JCLE9BQU8sRUFBRSxTQUFTO2FBQ3JCLENBQUMsQ0FBQztTQUNOO2FBQU07WUFDSCxNQUFNLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztTQUN6RDtLQUNKO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG5vUmVwZXRpciA9IG5ldyBTZXQoKTsgLy8gVGhpcyBzZXQgaXRzIGEgY29vbGRvd24gaW4gdGhlIGNvbW1hbmQgOkRcclxuaW1wb3J0IHsgQ2hhbm5lbCwgUmVnaXN0cmFkb3IgfSBmcm9tICcuLi8uLi9kYXRhYmFzZS8nO1xyXG5pbXBvcnQgeyBDb21tYW5kQmFzZSB9IGZyb20gJy4uLy4uL2xpYic7XHJcbmltcG9ydCBCb3QgZnJvbSAnLi4vLi4vYm90LmpzJztcclxuaW1wb3J0IHsgR3VpbGRDaGFubmVsLCBNZXNzYWdlLCBUZXh0Q2hhbm5lbCwgTWVzc2FnZUVtYmVkIH0gZnJvbSAnZGlzY29yZC5qcyc7XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNldHVwQ29tbWFuZCBleHRlbmRzIENvbW1hbmRCYXNlIHtcclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIC8vIE5hbWUsIENhdGVnb3J5LCBhbGlhcywgY29vbGRvd25cclxuICAgICAgICBzdXBlcignc2V0dXAnLCAnQWRtaW4nLCBbXCJpbmljaW9cIl0sIDMwMClcclxuICAgIH1cclxuICAgIGFzeW5jIHJ1bihib3Q6IEJvdCwgbWVzc2FnZTogTWVzc2FnZSwgYXJnczogQXJyYXk8c3RyaW5nPikge1xyXG4gICAgICAgIGlmIChtZXNzYWdlLmF1dGhvci5pZCAhPT0gbWVzc2FnZS5ndWlsZC5vd25lcklkKSByZXR1cm4gbWVzc2FnZS5jaGFubmVsLnNlbmQoYm90Lmxhbmd1YWdlLmdsb2JhbC5vbmx5T3duZXIpO1xyXG4gICAgICAgIGlmIChub1JlcGV0aXIuaGFzKG1lc3NhZ2UuYXV0aG9yLmlkKSkgcmV0dXJuO1xyXG4gICAgICAgIG5vUmVwZXRpci5hZGQobWVzc2FnZS5hdXRob3IuaWQpO1xyXG4gICAgICAgIGNvbnN0IGxhbmcgPSBib3QubGFuZ3VhZ2UuY29tbWFuZHMuc2V0dXA7XHJcbiAgICAgICAgY29uc3Qgd29yZHNTaSA9IFtcInNpXCIsIFwieWVzXCJdO1xyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIEZ1bmNpb24gcGFyYSBndWFyZGFyIGxvcyBkYXRvc1xyXG4gICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gcHJlZ3VudGExIFNpIHNvbG8gZWwgZHVlw7FvIGJvcnJhIGNhbmFsZXMgXHJcbiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHByZWd1bnRhMiBDYW5hbCBhIGVudmlhciBsb2dzIFxyXG4gICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gcHJlZ3VudGEzIFVzdWFyaW9zIGRldGVjYWRvcyBiYW4gYXV0byBcclxuICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSB1c3VhcmlvcyBVc3VhcmlvcyBsb3MgY3VhbGVzIHB1ZWRlbiB1c2FyIGVsIGJvdCBcclxuICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbWVzc2FnZSBFdmVudG8gbWVzc2FnZVxyXG4gICAgICAgICAqL1xyXG5cclxuICAgICAgICBsZXQgaSA9IDA7XHJcbiAgICAgICAgbGV0IHVzdWFyaW9zQcOxYWRpciA9IFtdOyAvLyBVc3VhcmlvcyBxdWUgc2UgYcOxYWRlblxyXG4gICAgICAgIGxldCBwcmVndW50YTE6IGJvb2xlYW47IC8vIE1vZG8gZXh0cmVtb1xyXG4gICAgICAgIGxldCBwcmVndW50YTI6IHN0cmluZzsgLy8gQ2FuYWwgYSBlbnZpYXIgcmVnaXN0cm9zXHJcbiAgICAgICAgbGV0IHByZWd1bnRhMzogYm9vbGVhbjsgLy8gRGV0ZWN0YXIgdXN1YXJpb3MgbWFsaWNpb3NvcyB5IGJhbmVhcmxvcyBhdXRvbWF0aWNhbWVudGVcclxuICAgICAgICBjb25zdCBwcmVndW50YTQ6IEFycmF5PHN0cmluZz4gPSBbXTtcclxuICAgICAgICBjb25zdCBwcmltZXJFbWJlZFJlc3BvbmRlciA9IG5ldyBNZXNzYWdlRW1iZWQoKVxyXG4gICAgICAgICAgICAuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKVxyXG4gICAgICAgICAgICAuc2V0Rm9vdGVyKGxhbmcuZm9vdGVyMSlcclxuICAgICAgICAgICAgLnNldERlc2NyaXB0aW9uKGxhbmcuZGVzY3JpcGNpb24xKVxyXG4gICAgICAgICAgICAuc2V0Q29sb3IoJyMxNkU3MjQnKVxyXG4gICAgICAgIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKHsgZW1iZWRzOiBbcHJpbWVyRW1iZWRSZXNwb25kZXJdIH0pO1xyXG4gICAgICAgIGNvbnN0IGZpbHRlciA9IChtOiBNZXNzYWdlKSA9PiBtLmF1dGhvci5pZCA9PT0gbWVzc2FnZS5hdXRob3IuaWQ7XHJcbiAgICAgICAgY29uc3QgY29sbGVjdG9yID0gbWVzc2FnZS5jaGFubmVsLmNyZWF0ZU1lc3NhZ2VDb2xsZWN0b3IoeyBmaWx0ZXIsIGlkbGU6IDEyMDAwMCB9KTtcclxuICAgICAgICBjb25zdCBtZW5zYWplRGVFcnJvciA9IG5ldyBNZXNzYWdlRW1iZWQoKS5zZXREZXNjcmlwdGlvbihsYW5nLm1lbnNhamVFcnJvcikuc2V0Rm9vdGVyKGxhbmcuZm9vdGVyRXJyb3IpLnNldENvbG9yKCcjRTcwOTE2Jykuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKVxyXG5cclxuXHJcbiAgICAgICAgY29sbGVjdG9yLm9uKFwiY29sbGVjdFwiLCBhc3luYyAobTogTWVzc2FnZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG5cclxuICAgICAgICAgICAgaWYgKG0uY29udGVudC50b0xvd2VyQ2FzZSgpID09PSBcImV4aXRcIikgcmV0dXJuIGNvbGxlY3Rvci5zdG9wKFwiZXhpdFwiKTtcclxuICAgICAgICAgICAgc3dpdGNoIChpKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDA6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKFtcImxpc3RvXCIsIFwic2tpcFwiLCBcInJlYWR5XCJdLmluY2x1ZGVzKG0uY29udGVudC50b0xvd2VyQ2FzZSgpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpKytcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG0uY29udGVudCkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXN1YXJpbyA9IG0ubWVudGlvbnMudXNlcnMuZmlyc3QoKSB8fCBhd2FpdCBib3QuY2xpZW50LnVzZXJzLmZldGNoKGAke0JpZ0ludChtLmNvbnRlbnQpfWApLmNhdGNoKGVyciA9PiB7IH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdXN1YXJpbykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaGFubmVsLnNlbmQoeyBlbWJlZHM6IFttZW5zYWplRGVFcnJvcl0gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXN1YXJpb3NBw7FhZGlyLmluY2x1ZGVzKHVzdWFyaW8uaWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnJlYWN0KCfinYwnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzdWFyaW9zQcOxYWRpci5wdXNoKHVzdWFyaW8uaWQpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG0ucmVhY3QoJ+KchScpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG1lc3NhZ2UuY2hhbm5lbC5zZW5kKHsgZW1iZWRzOiBbbWVuc2FqZURlRXJyb3JdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB4dHJlbUVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpLnNldERlc2NyaXB0aW9uKGxhbmcubWVuc2FqZUV4dHJlbW8pLnNldEZvb3RlcihsYW5nLmZvb3RlcjEpLnNldENvbG9yKCcjMTZFNzI0Jykuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW3h0cmVtRW1iZWRdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBjYXNlIDE6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmRzU2kuaW5jbHVkZXMobS5jb250ZW50LnRvTG93ZXJDYXNlKCkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZWd1bnRhMSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGkrK1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobS5jb250ZW50LnRvTG93ZXJDYXNlKCkgPT0gJ25vJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmVndW50YTEgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaSsrXHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaGFubmVsLnNlbmQobGFuZy5yZXNwdWVzdGFTaU5vKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dEVtYmVkID0gbmV3IE1lc3NhZ2VFbWJlZCgpLnNldEZvb3RlcihsYW5nLmZvb3RlckF0dGFjaykuc2V0RGVzY3JpcHRpb24obGFuZy5jYW5hbEVudmlhcikuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKS5zZXRDb2xvcigweEQzMDA4OSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgbWVzc2FnZS5jaGFubmVsLnNlbmQoeyBlbWJlZHM6IFthdHRFbWJlZF0gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUmVnaXN0cm9zIGRlIGF0YXF1ZVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAyOlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbmFsID0gbS5tZW50aW9ucy5jaGFubmVscy5maXJzdCgpIHx8IGF3YWl0IGJvdC5jbGllbnQuY2hhbm5lbHMuZmV0Y2goYCR7QmlnSW50KG0uY29udGVudCl9YCkuY2F0Y2goKCkgPT4gbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYW5hbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW21lbnNhamVEZUVycm9yXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vU2VydmVyRW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKCkuc2V0RGVzY3JpcHRpb24obGFuZy5ub1NlcnZlcikuc2V0Q29sb3IoMHhEMzAwODkpLnNldEF1dGhvcihtZXNzYWdlLm1lbWJlci5kaXNwbGF5TmFtZSwgbWVzc2FnZS5hdXRob3IuYXZhdGFyVVJMKHsgZHluYW1pYzogdHJ1ZSB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbmFsLmd1aWxkICE9IG0uZ3VpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaGFubmVsLnNlbmQoeyBlbWJlZHM6IFtub1NlcnZlckVtYmVkXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHByZWd1bnRhMiA9IGNhbmFsLmlkO1xyXG4gICAgICAgICAgICAgICAgICAgIGkrKztcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBhdXRvQmFuRW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKCkuc2V0Rm9vdGVyKGxhbmcuYXV0b2JhbkZvb3Rlcikuc2V0RGVzY3JpcHRpb24obGFuZy5hdXRvQmFuKS5zZXRDb2xvcigweEQzMDA4OSkuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW2F1dG9CYW5FbWJlZF0gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQXV0b0JhblxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAgICAgICAgIGNhc2UgMzpcclxuICAgICAgICAgICAgICAgICAgICBpZiAod29yZHNTaS5pbmNsdWRlcyhtLmNvbnRlbnQudG9Mb3dlckNhc2UoKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmVndW50YTMgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobS5jb250ZW50LnRvTG93ZXJDYXNlKCkgPT0gJ25vJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpKytcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJlZ3VudGEzID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeWVzTm9FbWJlZCA9IG5ldyBNZXNzYWdlRW1iZWQoKS5zZXREZXNjcmlwdGlvbihsYW5nLnJlc3B1ZXN0YVNpTm8pLnNldEF1dGhvcihtZXNzYWdlLm1lbWJlci5kaXNwbGF5TmFtZSwgbWVzc2FnZS5hdXRob3IuYXZhdGFyVVJMKHsgZHluYW1pYzogdHJ1ZSB9KSkuc2V0Q29sb3IoXCIjRUU0QkI1XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW3llc05vRW1iZWRdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHJvdGVjdGVkRW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKCkuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKS5zZXREZXNjcmlwdGlvbihsYW5nLnByb3RlY3RlZCkuc2V0Rm9vdGVyKGxhbmcucHJvdGVjdGVkRm9vdGVyKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW3Byb3RlY3RlZEVtYmVkXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgNDpcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKFsnbm8nLCAnc2tpcCcsICdsaXN0bycsICdyZWFkeSddLmluY2x1ZGVzKG0uY29udGVudC50b0xvd2VyQ2FzZSgpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxlY3Rvci5zdG9wKFwiRmluaXNoZWRcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FuYWxQcm90ZWdpZG8gPSBtLm1lbnRpb25zLmNoYW5uZWxzLmZpcnN0KCkgfHwgYXdhaXQgYm90LmNsaWVudC5jaGFubmVscy5mZXRjaChgJHtCaWdJbnQobS5jb250ZW50KX1gKS5jYXRjaCgoKSA9PiBudWxsKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2FuYWxQcm90ZWdpZG8pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9TZXJ2ZXJFbWJlZCA9IG5ldyBNZXNzYWdlRW1iZWQoKS5zZXREZXNjcmlwdGlvbihsYW5nLm5vU2VydmVyKS5zZXRDb2xvcigweEQzMDA4OSkuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbmFsUHJvdGVnaWRvLmd1aWxkICE9IG0uZ3VpbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKHsgZW1iZWRzOiBbbm9TZXJ2ZXJFbWJlZF0gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlZ3VudGE0Lmxlbmd0aCA+PSAzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnJlYWN0KCfinYwnKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9UcmVzRW1iZWRzID0gbmV3IE1lc3NhZ2VFbWJlZCgpLnNldEZvb3RlcihsYW5nLmNhbmFsZXNGb290ZXIpLnNldEF1dGhvcihtZXNzYWdlLm1lbWJlci5kaXNwbGF5TmFtZSwgbWVzc2FnZS5hdXRob3IuYXZhdGFyVVJMKHsgZHluYW1pYzogdHJ1ZSB9KSkuc2V0RGVzY3JpcHRpb24obGFuZy5ub01hczNjYW5hbGVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKHsgZW1iZWRzOiBbbm9UcmVzRW1iZWRzXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmVndW50YTQuaW5jbHVkZXMoY2FuYWxQcm90ZWdpZG8uaWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnJlYWN0KCfinYwnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZWd1bnRhNC5wdXNoKGNhbmFsUHJvdGVnaWRvLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbS5yZWFjdCgn4pyFJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm9DaGFubmVsRW1iZWQgPSBuZXcgTWVzc2FnZUVtYmVkKCkuc2V0QXV0aG9yKG1lc3NhZ2UubWVtYmVyLmRpc3BsYXlOYW1lLCBtZXNzYWdlLmF1dGhvci5hdmF0YXJVUkwoeyBkeW5hbWljOiB0cnVlIH0pKS5zZXREZXNjcmlwdGlvbihsYW5nLm5vQ2FuYWwpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW25vQ2hhbm5lbEVtYmVkXSB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbGxlY3Rvci5vbihcImVuZFwiLCBhc3luYyAoY29sbGVjdGVkLCByZWFzb24pID0+IHtcclxuICAgICAgICAgICAgbm9SZXBldGlyLmRlbGV0ZShtZXNzYWdlLmF1dGhvci5pZCk7XHJcbiAgICAgICAgICAgIGlmIChyZWFzb24gPT09IFwiZXhpdFwiKSByZXR1cm47XHJcbiAgICAgICAgICAgIGNvbnN0IG51ZXZvQ2FuYWwgPSBhd2FpdCBib3QuY2xpZW50LmNoYW5uZWxzLmZldGNoKGAke0JpZ0ludChwcmVndW50YTIpfWApLmNhdGNoKCgpID0+IG51bGwpIGFzIEd1aWxkQ2hhbm5lbCB8IFRleHRDaGFubmVsO1xyXG4gICAgICAgICAgICBsZXQgZGF0b3NQdXNoZWFkb3MgPSAnJztcclxuICAgICAgICAgICAgaWYgKCFwcmVndW50YTQubGVuZ3RoKVxyXG4gICAgICAgICAgICAgICAgZGF0b3NQdXNoZWFkb3MgPSBsYW5nLm5vYm9keTtcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHByZWd1bnRhNC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBhd2FpdCBib3QuY2xpZW50LmNoYW5uZWxzLmZldGNoKGAke0JpZ0ludChwcmVndW50YTRbaV0pfWApLmNhdGNoKCgpID0+IG51bGwpIGFzIEd1aWxkQ2hhbm5lbCB8IFRleHRDaGFubmVsO1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdG9zUHVzaGVhZG9zICs9IGAke2VsZW1lbnQudG9TdHJpbmcoKX1cXG5gO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN3aXRjaCAocmVhc29uKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdGaW5pc2hlZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdmVyaWZpY2FyKHByZWd1bnRhMSwgcHJlZ3VudGEyLCBwcmVndW50YTMsIHVzdWFyaW9zQcOxYWRpciwgbWVzc2FnZSwgcHJlZ3VudGE0KTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbWJlZEZpbmlzaCA9IG5ldyBNZXNzYWdlRW1iZWQoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuc2V0VGl0bGUobGFuZy50aXRsZTIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zZXREZXNjcmlwdGlvbihsYW5nLmRlc2NyaXBjaW9uMilcclxuICAgICAgICAgICAgICAgICAgICAgICAgLmFkZEZpZWxkcyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBsYW5nLmZpZWxkMSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB1c3Vhcmlvc0HDsWFkaXIubGVuZ3RoID09IDAgPyBsYW5nLm5vYm9keSA6IGAke3VzdWFyaW9zQcOxYWRpci5sZW5ndGh9YCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubGluZTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBsYW5nLmZpZWxkMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmVndW50YTEgPyBsYW5nLnNpIDogbGFuZy5ubyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlubGluZTogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBsYW5nLmZpZWxkMyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBudWV2b0NhbmFsLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmxpbmU6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbGFuZy5maWVsZDQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJlZ3VudGEzID8gbGFuZy5zaSA6IGxhbmcubm8sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmxpbmU6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogbGFuZy5maWVsZDUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZGF0b3NQdXNoZWFkb3MsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmxpbmU6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRDb2xvcihcIlJBTkRPTVwiKTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBtZXNzYWdlLmNoYW5uZWwuc2VuZCh7IGVtYmVkczogW2VtYmVkRmluaXNoXSB9KVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnaWRsZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5jaGFubmVsLnNlbmQobGFuZy5ub1RpbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVhc29uID09ICdleGl0JykgbWVzc2FnZS5jaGFubmVsLnNlbmQobGFuZy5jb25maWdDb21wbGV0YWRhKTtcclxuICAgICAgICAgICAgICAgICAgICBlbHNlIG1lc3NhZ2UuY2hhbm5lbC5zZW5kKGxhbmcuZXJyb3JDb2xlY3RvciArIHJlYXNvbikuY2F0Y2goKCkgPT4gbnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHZlcmlmaWNhcihwcmVndW50YTE6IGJvb2xlYW4sIHByZWd1bnRhMjogc3RyaW5nLCBwcmVndW50YTM6IGJvb2xlYW4sIHVzdWFyaW9zOiBBcnJheTxzdHJpbmc+LCBtZXNzYWdlOiBNZXNzYWdlLCBwcmVndW50YTQ6IEFycmF5PHN0cmluZz4pIHtcclxuICAgIGNvbnN0IGVzcXVlbWEgPSBuZXcgUmVnaXN0cmFkb3Ioe1xyXG4gICAgICAgIGd1aWxkSWQ6IG1lc3NhZ2UuZ3VpbGQuaWQsXHJcbiAgICAgICAgYXV0b2JhbjogcHJlZ3VudGEzLCAvLyBTaSBsb3MgdXN1YXJpb3MgZGV0ZWN0YWRvcyBzZXJhbiBiYW5lYWRvcyBhdXRvbWF0aWNhbWVudGVcclxuICAgICAgICBjaGFubmVsOiBwcmVndW50YTIsIC8vIENhbmFsIGEgZW52aWFyIGxvZ3NcclxuICAgICAgICB1c2VyczogdXN1YXJpb3MsIC8vIFVzdWFyaW9zIHBlcm1pdGlkb3NcclxuICAgICAgICBleHRyZW06IHByZWd1bnRhMSAvLyBTaSBzb2xvIGVsIGR1ZcOxbyBwdWVkZSBib3JyYXIgY2FuYWxlc1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBidXNjYXJFc3F1ZW1hcyA9IGF3YWl0IFJlZ2lzdHJhZG9yLmZpbmRCeUlkKG1lc3NhZ2UuZ3VpbGQuaWQpO1xyXG4gICAgYnVzY2FyRXNxdWVtYXMgPyBhd2FpdCBSZWdpc3RyYWRvci5maW5kQnlJZEFuZFVwZGF0ZShtZXNzYWdlLmd1aWxkLmlkLCB7IGF1dG9iYW46IHByZWd1bnRhMywgY2hhbm5lbDogcHJlZ3VudGEyLCB1c2VyczogdXN1YXJpb3MsIGV4dHJlbTogcHJlZ3VudGExIH0pIDogYXdhaXQgZXNxdWVtYS5zYXZlKCk7XHJcbiAgICBpZiAocHJlZ3VudGE0Lmxlbmd0aCA+PSAxKSB7XHJcbiAgICAgICAgY29uc3QgYnVzY2FyQ2FuYWxlcyA9IGF3YWl0IENoYW5uZWwuZmluZEJ5SWQobWVzc2FnZS5ndWlsZC5pZCk7XHJcbiAgICAgICAgaWYgKCFidXNjYXJDYW5hbGVzKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IENoYW5uZWwuY3JlYXRlKHtcclxuICAgICAgICAgICAgICAgIF9pZDogbWVzc2FnZS5ndWlsZC5pZCxcclxuICAgICAgICAgICAgICAgIGNoYW5uZWw6IHByZWd1bnRhNFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhd2FpdCBidXNjYXJDYW5hbGVzLnVwZGF0ZU9uZSh7IGNoYW5uZWw6IHByZWd1bnRhNCB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=