"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const coleccion = new Map();
const espanol_1 = __importDefault(require("../../lang/espanol"));
const database_1 = require("../../database/");
const english_1 = __importDefault(require("../../lang/english"));
const lib_1 = require("../../lib");
class DeleteChannelEvent extends lib_1.BaseEvent {
    constructor() {
        super('channelDelete');
    }
    async run(bot, channel) {
        if (!channel.guild.me.permissions.has(["BAN_MEMBERS", "VIEW_AUDIT_LOG"]))
            return;
        const search = await database_1.Registrador.findById(channel.guild.id);
        if (!search)
            return;
        let idioma;
        const searchLang = await database_1.Langs.findById(channel.guild.id);
        if (!searchLang)
            idioma = english_1.default;
        else
            searchLang.lang == 'es' ? idioma = espanol_1.default : idioma = english_1.default;
        const contestar = idioma.events.channelDelete;
        const fetchedLogs = await channel.guild.fetchAuditLogs({
            limit: 1,
            type: 'CHANNEL_DELETE',
        });
        const deletionLog = fetchedLogs.entries.first();
        if (!deletionLog)
            return;
        const canalReportes = await bot.client.channels.fetch(`${BigInt(search.channel)}`).catch(err => { });
        const { executor } = deletionLog;
        let comprobacion = false;
        const searchProtected = await database_1.Channel.findOne({ guildId: channel.guild.id });
        if (searchProtected && searchProtected.channel.includes(channel.id))
            comprobacion = true;
        if (!comprobacion) {
            if (search.users.includes(executor.id) || executor.id == channel.guild.ownerId)
                return; // Si no existen los canales protegidos y los autores no fueron los de la lista se seguira el proceso
        }
        else {
            if (channel.guild.ownerId == executor.id)
                return;
            const newChannel = await lib_1.createChannel(channel, idioma); // Creamos el canal denuevo;
            await Promise.all([channel.guild.members.ban(executor.id), lib_1.sendMessages(newChannel, channel), lib_1.changeChannel(channel, newChannel)]);
            if (canalReportes)
                canalReportes.send(executor.tag + " " + contestar.protegido);
            return;
        } // Si es que existen canales protegidos
        if (search.extrem) {
            await channel.guild.members.ban(executor.id, { days: 7, reason: contestar.reasonBan });
            if (canalReportes)
                canalReportes.send(contestar.reportChannel1 + executor.tag + contestar.reportChannel2Xtreme);
            await lib_1.createChannel(channel, idioma);
        }
        else {
            if (!coleccion.has(executor.id)) {
                coleccion.set(executor.id, 10);
            }
            else if (coleccion.get(executor.id) >= 20) {
                channel.guild.members.ban(executor.id, { days: 7, reason: contestar.reasonBan });
                if (canalReportes)
                    canalReportes.send(contestar.reportChannel1 + executor.tag + contestar.reportChannel2);
            }
            else {
                const n = coleccion.get(executor.id);
                coleccion.set(executor.id, n + 10);
            }
            setTimeout(() => {
                if (coleccion.has(executor.id))
                    coleccion.delete(executor.id);
            }, 20 * 1000); // Si borra 3 canales en menos de 20 segundos se va baneado :D
        }
    }
}
exports.default = DeleteChannelEvent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbm5lbERlbGV0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9ldmVudHMvY2hhbm5lbHMvY2hhbm5lbERlbGV0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE1BQU0sU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7QUFDNUIsaUVBQXlDO0FBQ3pDLDhDQUE4RDtBQUM5RCxpRUFBd0M7QUFDeEMsbUNBQWtGO0FBR2xGLE1BQXFCLGtCQUFtQixTQUFRLGVBQVM7SUFDckQ7UUFDSSxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUNELEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBUSxFQUFFLE9BQXFCO1FBQ3JDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFBRSxPQUFPO1FBRWpGLE1BQU0sTUFBTSxHQUFHLE1BQU0sc0JBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RCxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU87UUFFcEIsSUFBSSxNQUFNLENBQUM7UUFDWCxNQUFNLFVBQVUsR0FBRyxNQUFNLGdCQUFLLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLFVBQVU7WUFBRSxNQUFNLEdBQUcsaUJBQU0sQ0FBQzs7WUFDNUIsVUFBVSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxpQkFBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsaUJBQU0sQ0FBQztRQUdsRSxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQztRQUM5QyxNQUFNLFdBQVcsR0FBRyxNQUFNLE9B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USxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO2dCQUNqRixJQUFJLGFBQWE7b0JBQUUsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFBO2FBQzVHO2lCQUFNO2dCQUNILE1BQU0sQ0FBQyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUNwQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFBO2FBQ3JDO1lBQ0QsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFJLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztvQkFBRSxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUNqRSxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsOERBQThEO1NBRWhGO0lBRUwsQ0FBQztDQUNKO0FBOURELHFDQThEQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNvbGVjY2lvbiA9IG5ldyBNYXAoKTtcclxuaW1wb3J0IGVzcGFub2wgZnJvbSAnLi4vLi4vbGFuZy9lc3Bhbm9sJztcclxuaW1wb3J0IHsgUmVnaXN0cmFkb3IsIExhbmdzLCBDaGFubmVsIH0gZnJvbSBcIi4uLy4uL2RhdGFiYXNlL1wiO1xyXG5pbXBvcnQgaW5nbGVzIGZyb20gJy4uLy4uL2xhbmcvZW5nbGlzaCc7XHJcbmltcG9ydCB7IGNoYW5nZUNoYW5uZWwsIGNyZWF0ZUNoYW5uZWwsIHNlbmRNZXNzYWdlcywgQmFzZUV2ZW50IH0gZnJvbSAnLi4vLi4vbGliJztcclxuaW1wb3J0IEJvdCBmcm9tICcuLi8uLi9ib3QnO1xyXG5pbXBvcnQgeyBHdWlsZENoYW5uZWwsIFRleHRDaGFubmVsIH0gZnJvbSAnZGlzY29yZC5qcyc7XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERlbGV0ZUNoYW5uZWxFdmVudCBleHRlbmRzIEJhc2VFdmVudCB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcignY2hhbm5lbERlbGV0ZScpO1xyXG4gICAgfVxyXG4gICAgYXN5bmMgcnVuKGJvdDogQm90LCBjaGFubmVsOiBHdWlsZENoYW5uZWwpIHtcclxuICAgICAgICBpZiAoIWNoYW5uZWwuZ3VpbGQubWUucGVybWlzc2lvbnMuaGFzKFtcIkJBTl9NRU1CRVJTXCIsIFwiVklFV19BVURJVF9MT0dcIl0pKSByZXR1cm47XHJcblxyXG4gICAgICAgIGNvbnN0IHNlYXJjaCA9IGF3YWl0IFJlZ2lzdHJhZG9yLmZpbmRCeUlkKGNoYW5uZWwuZ3VpbGQuaWQpO1xyXG4gICAgICAgIGlmICghc2VhcmNoKSByZXR1cm47XHJcblxyXG4gICAgICAgIGxldCBpZGlvbWE7XHJcbiAgICAgICAgY29uc3Qgc2VhcmNoTGFuZyA9IGF3YWl0IExhbmdzLmZpbmRCeUlkKGNoYW5uZWwuZ3VpbGQuaWQpO1xyXG4gICAgICAgIGlmICghc2VhcmNoTGFuZykgaWRpb21hID0gaW5nbGVzO1xyXG4gICAgICAgIGVsc2Ugc2VhcmNoTGFuZy5sYW5nID09ICdlcycgPyBpZGlvbWEgPSBlc3Bhbm9sIDogaWRpb21hID0gaW5nbGVzO1xyXG5cclxuXHJcbiAgICAgICAgY29uc3QgY29udGVzdGFyID0gaWRpb21hLmV2ZW50cy5jaGFubmVsRGVsZXRlO1xyXG4gICAgICAgIGNvbnN0IGZldGNoZWRMb2dzID0gYXdhaXQgY2hhbm5lbC5ndWlsZC5mZXRjaEF1ZGl0TG9ncyh7XHJcbiAgICAgICAgICAgIGxpbWl0OiAxLFxyXG4gICAgICAgICAgICB0eXBlOiAnQ0hBTk5FTF9ERUxFVEUnLFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBkZWxldGlvbkxvZyA9IGZldGNoZWRMb2dzLmVudHJpZXMuZmlyc3QoKTtcclxuICAgICAgICBpZiAoIWRlbGV0aW9uTG9nKSByZXR1cm47XHJcbiAgICAgICAgY29uc3QgY2FuYWxSZXBvcnRlcyA9IGF3YWl0IGJvdC5jbGllbnQuY2hhbm5lbHMuZmV0Y2goYCR7QmlnSW50KHNlYXJjaC5jaGFubmVsKX1gKS5jYXRjaChlcnIgPT4ge30pIGFzIFRleHRDaGFubmVsO1xyXG4gICAgICAgIGNvbnN0IHsgZXhlY3V0b3IgfSA9IGRlbGV0aW9uTG9nO1xyXG4gICAgICAgIGxldCBjb21wcm9iYWNpb24gPSBmYWxzZTtcclxuICAgICAgICBjb25zdCBzZWFyY2hQcm90ZWN0ZWQgPSBhd2FpdCBDaGFubmVsLmZpbmRPbmUoeyBndWlsZElkOiBjaGFubmVsLmd1aWxkLmlkIH0pO1xyXG4gICAgICAgIGlmIChzZWFyY2hQcm90ZWN0ZWQgJiYgc2VhcmNoUHJvdGVjdGVkLmNoYW5uZWwuaW5jbHVkZXMoY2hhbm5lbC5pZCkpIGNvbXByb2JhY2lvbiA9IHRydWU7XHJcblxyXG4gICAgICAgIGlmICghY29tcHJvYmFjaW9uKSB7XHJcbiAgICAgICAgICAgIGlmIChzZWFyY2gudXNlcnMuaW5jbHVkZXMoZXhlY3V0b3IuaWQpIHx8IGV4ZWN1dG9yLmlkID09IGNoYW5uZWwuZ3VpbGQub3duZXJJZCkgcmV0dXJuOyAvLyBTaSBubyBleGlzdGVuIGxvcyBjYW5hbGVzIHByb3RlZ2lkb3MgeSBsb3MgYXV0b3JlcyBubyBmdWVyb24gbG9zIGRlIGxhIGxpc3RhIHNlIHNlZ3VpcmEgZWwgcHJvY2Vzb1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChjaGFubmVsLmd1aWxkLm93bmVySWQgPT0gZXhlY3V0b3IuaWQpIHJldHVybjtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q2hhbm5lbCA9IGF3YWl0IGNyZWF0ZUNoYW5uZWwoY2hhbm5lbCwgaWRpb21hKTsgLy8gQ3JlYW1vcyBlbCBjYW5hbCBkZW51ZXZvO1xyXG4gICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbY2hhbm5lbC5ndWlsZC5tZW1iZXJzLmJhbihleGVjdXRvci5pZCksIHNlbmRNZXNzYWdlcyhuZXdDaGFubmVsLCBjaGFubmVsKSwgY2hhbmdlQ2hhbm5lbChjaGFubmVsLCBuZXdDaGFubmVsKV0pXHJcbiAgICAgICAgICAgIGlmIChjYW5hbFJlcG9ydGVzKSBjYW5hbFJlcG9ydGVzLnNlbmQoZXhlY3V0b3IudGFnICsgXCIgXCIgKyBjb250ZXN0YXIucHJvdGVnaWRvKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gLy8gU2kgZXMgcXVlIGV4aXN0ZW4gY2FuYWxlcyBwcm90ZWdpZG9zXHJcblxyXG4gICAgICAgIGlmIChzZWFyY2guZXh0cmVtKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGNoYW5uZWwuZ3VpbGQubWVtYmVycy5iYW4oZXhlY3V0b3IuaWQsIHsgZGF5czogNywgcmVhc29uOiBjb250ZXN0YXIucmVhc29uQmFuIH0pO1xyXG4gICAgICAgICAgICBpZiAoY2FuYWxSZXBvcnRlcykgY2FuYWxSZXBvcnRlcy5zZW5kKGNvbnRlc3Rhci5yZXBvcnRDaGFubmVsMSArIGV4ZWN1dG9yLnRhZyArIGNvbnRlc3Rhci5yZXBvcnRDaGFubmVsMlh0cmVtZSk7XHJcbiAgICAgICAgICAgIGF3YWl0IGNyZWF0ZUNoYW5uZWwoY2hhbm5lbCwgaWRpb21hKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgICAgaWYgKCFjb2xlY2Npb24uaGFzKGV4ZWN1dG9yLmlkKSkge1xyXG4gICAgICAgICAgICAgICAgY29sZWNjaW9uLnNldChleGVjdXRvci5pZCwgMTApXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY29sZWNjaW9uLmdldChleGVjdXRvci5pZCkgPj0gMjApIHtcclxuICAgICAgICAgICAgICAgIGNoYW5uZWwuZ3VpbGQubWVtYmVycy5iYW4oZXhlY3V0b3IuaWQsIHsgZGF5czogNywgcmVhc29uOiBjb250ZXN0YXIucmVhc29uQmFuIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNhbmFsUmVwb3J0ZXMpIGNhbmFsUmVwb3J0ZXMuc2VuZChjb250ZXN0YXIucmVwb3J0Q2hhbm5lbDEgKyBleGVjdXRvci50YWcgKyBjb250ZXN0YXIucmVwb3J0Q2hhbm5lbDIpXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuID0gY29sZWNjaW9uLmdldChleGVjdXRvci5pZClcclxuICAgICAgICAgICAgICAgIGNvbGVjY2lvbi5zZXQoZXhlY3V0b3IuaWQsIG4gKyAxMClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjb2xlY2Npb24uaGFzKGV4ZWN1dG9yLmlkKSkgY29sZWNjaW9uLmRlbGV0ZShleGVjdXRvci5pZClcclxuICAgICAgICAgICAgfSwgMjAgKiAxMDAwKTsgLy8gU2kgYm9ycmEgMyBjYW5hbGVzIGVuIG1lbm9zIGRlIDIwIHNlZ3VuZG9zIHNlIHZhIGJhbmVhZG8gOkRcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxufSJdfQ==